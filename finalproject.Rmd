---
title: "Final Project"
author: "Group 4"
date: "5/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, results = FALSE, warning = FALSE)
library(tidyverse)
library(readxl)
```

```{r}
schools <- read_xlsx("US_schools_data.xlsx")
```
# United States Education Data Analysis

## US Schools Dataset

In this report, the US Schools Data will be investigated to create a linear regression model  (source: https://www.kaggle.com/noriuk/us-education-datasets-unification-project). In this dataset from Urban Institute's API, multiple facets of U.S. educational data was taken from each of the fifty mainland states in the years 1992 to 2017. The data accounts for the states' number of students in a wide variety of grade levels, from pre-kindergarten to grade 12. Additionally, the number of students in different race and sex categories is identified along with the expenditures/revenues in regards to education of each state. Average scores from the Reading and Math NAEP exams were recorded for students in grades 4 and 8.


```{r}
clean_schools <-schools %>%
  select(PRIMARY_KEY,
         TOTAL_EXPENDITURE, 
         INSTRUCTION_EXPENDITURE, 
         SUPPORT_SERVICES_EXPENDITURE, 
         OTHER_EXPENDITURE, 
         CAPITAL_OUTLAY_EXPENDITURE, 
         ends_with("READING"), 
         ends_with("MATHEMATICS"))
```

```{r}

clean_schools$PRIMARY_KEY <- str_replace(clean_schools$PRIMARY_KEY,"_", " ")

clean_schools <- clean_schools %>%
  separate(PRIMARY_KEY, 
           into = c("year", "state"), 
           sep = " ")

clean_schools$state <- str_replace_all(clean_schools$state, "_", " ")


```

```{r}
clean_schools <- clean_schools %>%
  pivot_longer("G04_A_A_READING":"G08_TR_A_MATHEMATICS",
               names_to = c("grade","race", "sex", "test"),
               names_sep = "_",
               values_to = "score")
```


```{r}
clean_schools <- clean_schools %>%
  mutate(sex = as.factor(sex),
         race = fct_recode(as.factor(clean_schools$race), 
                           all = "A",
                           asian = "AS",
                           hispanic = "HI",
                           black = "BL",
                           white = "WH",
                           pacific_islander = "HP",
                           two_or_more = "TR",
                           native_american = "AM"),
         test = as.factor(test),
         grade =as.factor(grade),
         INSTRUCTION_EXPENDITURE = INSTRUCTION_EXPENDITURE / 1000000
         )
  
```

### Regional Categorization

To better analyze the similarities and differences with educational systems due to geographical and social distinctions, the states have been categorized into the regions Midwest, Northeast, South, and West. These  labels are the most common way of referring to the nation's differing regions, although, here, we combined Southeast with Southwest into the region South so that the regions have relatively similar number of states (source:https://www.nationalgeographic.org/maps/united-states-regions/)



```{r}
MIDWEST <- c("INDIANA",
             "ILLINOIS",
             "MICHIGAN",
             "OHIO",
             "WISCONSIN",
             "IOWA",
             "KANSAS",
             "MINNESOTA",
             "MISSOURI",
             "NEBRASKA",
             "NORTH DAKOTA",
             "SOUTH DAKOTA")

NORTHEAST <- c("CONNECTICUT",
               "MAINE",
               "MASSACHUSETTS",
               "NEW HAMPSHIRE",
             "RHODE ISLAND",
             "VERMONT",
             "NEW JERSEY",
             "NEW YORK",
             "PENNSYLVANIA")

SOUTH <- c("DELAWARE",
           "DISTRICT",
           "FLORIDA",
           "GEORGIA",
            "MARYLAND",
           "NORTH CAROLINA",
           "SOUTH CAROLINA",
           "VIRGINIA",
            "WEST VIRGINIA",
           "ALABAMA","KENTUCKY",
           "MISSISSIPPI",
            "TENNESSEE",
           "ARKANSAS",
           "LOUISIANA",
           "OKLAHOMA",
           "TEXAS")

WEST <- c("ARIZONA",
          "COLORADO",
          "IDAHO",
          "NEW MEXICO",
          "MONTANA",
            "UTAH",
          "NEVADA",
          "WYOMING",
          "ALASKA",
          "CALIFORNIA",
            "HAWAII",
          "OREGON",
          "WASHINGTON")

clean_schools <- clean_schools %>%
  mutate(region = if_else(state %in% MIDWEST, "Midwest", 
                          if_else(state %in% NORTHEAST, "Northeast", 
                                  if_else(state %in% SOUTH, "South", 
                                          if_else(state %in% WEST, "West", "Other")))))

```


The plot below explores how the differnces in relationship between testing scores and instructional expenditures by region. There doesn't appear to be a relationship that governs all regions. The **West** region has a relationship that increases at lower expenditures, but the decreases as more money is spent before it increases again. The **Northeast** region has the highest testing scores, but the relationship between scores and instructional expenditures is relatively flat. The only region where we see a positive relationship between scores and instructional expenditure is in the **South**.

```{r}
clean_schools %>%
  group_by(region) %>%
  ggplot(aes(x = INSTRUCTION_EXPENDITURE, y = score, color = region)) +
  geom_smooth() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        text=element_text(size=12, 
                          family="serif"),
                          axis.text.y = element_text(size = 16))+
  labs(title = "Test Scores and Instructional Expenditures by Region",
       x = "Instructional Expenditures (millions $)", 
       y = "Testing scores")  

# I don't think we should include this plot
clean_schools %>%
  ggplot(aes(x = INSTRUCTION_EXPENDITURE, y = score)) +
  #geom_point() +
  geom_smooth() +
  labs(x = "Instructional Expenditures (millions $)", 
       y = "Testing scores")  +
  facet_wrap(~race)
```

``` {r, include = FALSE}
clean_schools %>%
  ggplot(aes(x = INSTRUCTION_EXPENDITURE, y = score, color = sex)) +
  geom_point() +
  labs(x = "Instructional Expenditures ($)", 
       y = "Testing scores")  +
  facet_wrap(~sex)
```

#### Distribution of Test Scores
Looking at the distribution of test scores, it appears that kids score higher in mathematics than reading, regardless of the grade level. There is a significant jump in test scores for both tests from fourth grade to eighth grade. This is expected as eighth graders have a higher education level and are older than the fourth graders.

```{r initial visuals, include = FALSE}
clean_schools %>%
  ggplot()+
  geom_density(mapping = aes(x = score, fill = test), alpha = 0.5)+
  facet_wrap(~race) +
  labs(title = "Math and Test Scores Density", x = "Test Scores", fill = "Test")
```

``` {r}
clean_schools %>%
  ggplot()+
  geom_density(mapping = aes(x = score, fill = test), alpha = 0.5)+
  facet_wrap(~grade) +
  labs(title = "Math and Test Scores Density", x = "Test Scores", fill = "Test")
```

```{r}
clean_schools %>%
  #filter(!is.na(INSTRUCTION_EXPENDITURE)) %>%
  group_by(year, region, race, sex) %>%
  mutate(  avg = mean(INSTRUCTION_EXPENDITURE, na.rm = TRUE),
         year = as.factor(year)) %>%
  ggplot(mapping = aes(x = year, y = avg, color = region))+
  geom_point() +
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        text=element_text(size=12, 
                          family="serif"),
                          axis.text.y = element_text(size = 16))+
  labs(title = "Average Instruction Expenditure over time for the different regions", y = "Average Instruction Expenditure (in millions $)", x = "Year")
```

```{r visuals}
clean_schools %>%
  group_by(year, region) %>%
  filter(year > 1992 & year < 2017) %>%
  mutate(
    avg = mean(INSTRUCTION_EXPENDITURE, na.rm = TRUE),
         year = as.factor(year)) %>%
  ggplot(mapping = aes(x = year, 
                       y = avg,
                       group = region,
                       color = fct_reorder2(region, year, INSTRUCTION_EXPENDITURE)))+
  geom_line() +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  #scale_colour_brewer(palette = "Paired") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        text=element_text(size=12, 
                          family="serif"),
                          axis.text.y = element_text(size = 16))+
  # code for removing gridlines from https://felixfan.github.io/ggplot2-remove-grid-background-margin/
  # code for font from https://stackoverflow.com/questions/34522732/changing-fonts-in-ggplot2
  # annotation from https://ggplot2.tidyverse.org/reference/annotate.html
  labs(title = "Average Instruction Expenditure Over Time by Region",
       x = "Year",
       y = "Average Instruction Expenditure (Millions $)",
       color = "Region")+
  annotate("text", 
           x = "2012", 
           y = 7.75, 
           label = "Large increase \n for Northeast",
           size = 2)

```


```{r}
clean_schools %>%
  filter(test == "MATHEMATICS",
         !is.na(score)) %>%
  lm(score ~ INSTRUCTION_EXPENDITURE, data = .) ->
  math_model

clean_schools %>%
  filter(test == "READING",
         !is.na(score)) %>%
  lm(score ~ INSTRUCTION_EXPENDITURE, data = .) ->
  reading_model
```

```{r}
summary(math_model)
# math model has higher r^2
summary(reading_model)
```


```{r}
clean_schools %>%
  lm(score ~ test, data = .) ->
  test_model
summary(test_model)
```

```{r}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year, data = .) %>%
  summary()
```
```{r}
clean_schools %>%
  mutate(year = as.numeric(year),
         state = as.factor(state)) %>%
  lm(score ~ test + year + SUPPORT_SERVICES_EXPENDITURE, data = .) %>%
  summary()
```

```{r}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region + SUPPORT_SERVICES_EXPENDITURE, data = .) %>%
  summary()
```

```{r}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region + SUPPORT_SERVICES_EXPENDITURE + race, data = .) %>%
  summary()
```

```{r}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region + race, data = .) %>%
  summary()
```

```{r}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region + SUPPORT_SERVICES_EXPENDITURE + race + grade, data = .) %>%
  summary()
```

```{r}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region +  race + grade + INSTRUCTION_EXPENDITURE, data = .) %>%
  summary()
```


```{r final model}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region + race + grade , data = .) %>%
  summary()
```

## Linear Regression 

#### Model Selection
For our model selection process our main criteria was Adjusted R^2^. Since adding any variables, regardless of whether it explains any variation in the data, inflates the R^2^. Adjusted R^2^ takes this into account and penalizes unnecessary additional variables. We started with a simple linear regression model starting with the test scores as the response variable and the type of test as the explanatory variable. After this baseline model, we added additional variables one-by-one and checked the Adjusted R^2^ to see if the new variable is useful in the model. We looked for the Adjusted R^2^ to increase at least 3% in order to include it in the model. We did this in order to get the simplest model with the most influential variables.

#### Final Model
After going through the model selection process, we finalized our multiple linear regression model with the following variables: 

* type of test
* year
* region
* grade

These variables were the most influential according to our model. The visualization below includes all the variables in our final model. It appears that grade followed by the type of test and race are the most influential. 



```{r visualization of model, echo = FALSE}
clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(mapping = aes(x = year, 
                           y = score,
                           color = race))+
  geom_point()+
  geom_jitter()+
  #stat_smooth(method = "lm")+
  facet_grid(rows = vars(test), cols = vars(grade))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```


Since there is only data on the different races after 2010, the graph below looks a little closer into the relationship between different races. There does seem to be a difference between


```{r}
clean_schools %>%
  filter(year >= 2010,
         race != "all") %>%
  mutate(year = as.factor(year)) %>%
  ggplot(mapping = aes(x = year, 
                           y = score,
                           color = race))+
  geom_point()+
  geom_jitter()+
  stat_smooth(method = "lm")+
  facet_grid(rows = vars(test), cols = vars(grade))+
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```


## Predictive Check

To make the simulations for the predictive check on our model, we created the noise() function to add errors to the predictions, removing missing values and iterating this 1000 times. From there, we added the observed schools data to the simulated data for easier visualization and extracted the R-squared values from each simulation to visualize them with the histogram below. 

```{r}
schools_lm <- clean_schools %>%
  mutate(year = as.numeric(year)) %>%
  lm(score ~ test + year + region + race + grade + INSTRUCTION_EXPENDITURE, data = .)
schools_predict <- predict(schools_lm)
schools_sigma <- sigma(schools_lm)
```

```{r Function to add Errors}
noise <- function(x, mean = 0, sd){
  n <- length(x)
  new_data <- x + rnorm(n, mean, sd)
  return(new_data)
}
```

```{r Making Tibble of Predictions}
new_data <- tibble(
  predict_score = noise(schools_predict,
                         sd = schools_sigma)
)
```

```{r Removing NAs From Observed}
new_data <- clean_schools %>% 
  filter(!is.na(score), 
         !is.na(test), 
         !is.na(year),
         !is.na(region),
         !is.na(race),
         !is.na(grade),
         !is.na(INSTRUCTION_EXPENDITURE)) %>% 
  select(score, test, year, region, race, grade,
         INSTRUCTION_EXPENDITURE) %>% 
  bind_cols(new_data)
```

```{r Iterating Simulations}
nsims <- 1000

sims <- map_dfc(1:nsims, ~tibble(
  sim = noise(schools_predict, 
              sd = schools_sigma)))
```

```{r Replacing column names ... with _}
colnames(sims) <- colnames(sims) %>% 
  str_replace(pattern = "\\.\\.\\.",
                  replace = "_")
```

```{r Add Observed into Simulated}
sims <- clean_schools %>% 
filter(!is.na(score), 
         !is.na(test), 
         !is.na(year),
         !is.na(region),
         !is.na(race),
         !is.na(grade),
         !is.na(INSTRUCTION_EXPENDITURE)) %>%  
  select(score) %>% 
  bind_cols(sims)
```

```{r}
sim_r_sq <- sims %>% 
  map( ~lm(score ~ .x, data = sims)) %>% 
  map(broom::glance) %>% 
  map_dbl(~.$r.squared)
```

```{r}
sim_r_sq <- sim_r_sq[names(sim_r_sq) != "score"]
head(sim_r_sq)
```

```{r}
tibble(sims = sim_r_sq) %>% 
  ggplot(aes(x = sims)) + 
  geom_histogram()
```

From the simulation performed above, it is clear that the model describes the relationships of the variables included with a high amount of accuracy. In other words, the model actually accounts for around 85% of the variability in the observed schools data, so that only a small proportion is not accounted for, making this model a relatively good fit. 
